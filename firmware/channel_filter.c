

//MIT License
//
//Copyright (c) 2019 tvelliott
//
//Permission is hereby granted, free of charge, to any person obtaining a copy
//of this software and associated documentation files (the "Software"), to deal
//in the Software without restriction, including without limitation the rights
//to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
//copies of the Software, and to permit persons to whom the Software is
//furnished to do so, subject to the following conditions:
//
//The above copyright notice and this permission notice shall be included in all
//copies or substantial portions of the Software.
//
//THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
//IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
//FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
//AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
//LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
//OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
//SOFTWARE.





#include <math.h>
#include <float.h>
#include <complex.h>
#include "arm_math.h"
#include "channel_filter.h"


//decimation
static float32_t fir_dec_state_f32_I_2[NSAMPLES + 128 - 1];
static float32_t fir_dec_state_f32_Q_2[NSAMPLES + 128 - 1];
static arm_fir_decimate_instance_f32 Si_dec_2;
static arm_fir_decimate_instance_f32 Sq_dec_2;

static float32_t fir_dec_state_f32_I_4[NSAMPLES + 128 - 1];
static float32_t fir_dec_state_f32_Q_4[NSAMPLES + 128 - 1];
static arm_fir_decimate_instance_f32 Si_dec_4;
static arm_fir_decimate_instance_f32 Sq_dec_4;

static float32_t fir_dec_state_f32_I_8[NSAMPLES + 256 - 1];
static float32_t fir_dec_state_f32_Q_8[NSAMPLES + 256 - 1];
static arm_fir_decimate_instance_f32 Si_dec_8;
static arm_fir_decimate_instance_f32 Sq_dec_8;

static float32_t fir_dec_state_f32_I_16[NSAMPLES + 512 - 1];
static float32_t fir_dec_state_f32_Q_16[NSAMPLES + 512 - 1];
static arm_fir_decimate_instance_f32 Si_dec_16;
static arm_fir_decimate_instance_f32 Sq_dec_16;

float32_t iout[256];
float32_t qout[256];

/////////////////////////////////////////////////////////
//-d1 -b0.1 -l128 -c2 -w4 -g0.8 -a20  //-2dB gain
//
// This filter results in excellent performance
// for dec=4, flt=2 when decoding P25 and DMR
/////////////////////////////////////////////////////////
const float32_t channel_filter_quarterbw[] = {
  0.00001, 0.00001, 0.00001, 0.00001, -0.00001, -0.00004, -0.00006, -0.00007, -0.00004, 0.00005, 0.00017, 0.00028, 0.00029, 0.00014, -0.00017, -0.00057, -0.00086
  , -0.00086, -0.00040, 0.00048, 0.00152, 0.00224, 0.00215, 0.00097, -0.00114, -0.00351, -0.00506, -0.00475, -0.00210, 0.00242, 0.00728, 0.01030, 0.00951
  , 0.00413, -0.00469, -0.01389, -0.01937, -0.01765, -0.00757, 0.00849, 0.02488, 0.03438, 0.03104, 0.01322, -0.01473, -0.04293, -0.05908, -0.05322, -0.02265
  , 0.02527, 0.07392, 0.10236, 0.09310, 0.04017, -0.04566, -0.13701, -0.19626, -0.18681, -0.08575, 0.10627, 0.36169, 0.63113, 0.85572, 0.98329, 0.98329
  , 0.85572, 0.63113, 0.36169, 0.10627, -0.08575, -0.18681, -0.19626, -0.13701, -0.04566, 0.04017, 0.09310, 0.10236, 0.07392, 0.02526, -0.02265, -0.05322
  , -0.05908, -0.04293, -0.01473, 0.01322, 0.03104, 0.03438, 0.02488, 0.00849, -0.00757, -0.01765, -0.01937, -0.01389, -0.00469, 0.00413, 0.00951, 0.01030
  , 0.00728, 0.00242, -0.00210, -0.00475, -0.00506, -0.00351, -0.00114, 0.00097, 0.00215, 0.00224, 0.00152, 0.00048, -0.00040, -0.00086, -0.00086, -0.00057
  , -0.00017, 0.00014, 0.00029, 0.00028, 0.00017, 0.00005, -0.00004, -0.00007, -0.00006, -0.00004, -0.00001, 0.00001, 0.00001, 0.00001, 0.00001
};

const float32_t channel_filter_eighthbw[] = {
  -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, 0.00000, 0.00000, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00000, -0.00001
  , -0.00002, -0.00003, -0.00004, -0.00004, -0.00004, -0.00003, -0.00001, 0.00001, 0.00005, 0.00008, 0.00010, 0.00012, 0.00011, 0.00008, 0.00003, -0.00004
  , -0.00011, -0.00019, -0.00024, -0.00027, -0.00025, -0.00018, -0.00007, 0.00008, 0.00024, 0.00039, 0.00051, 0.00055, 0.00051, 0.00037, 0.00014, -0.00015
  , -0.00047, -0.00076, -0.00097, -0.00105, -0.00096, -0.00069, -0.00026, 0.00028, 0.00086, 0.00138, 0.00174, 0.00187, 0.00170, 0.00121, 0.00045, -0.00049
  , -0.00147, -0.00235, -0.00296, -0.00315, -0.00284, -0.00202, -0.00075, 0.00080, 0.00242, 0.00384, 0.00480, 0.00508, 0.00456, 0.00323, 0.00120, -0.00127
  , -0.00382, -0.00604, -0.00753, -0.00795, -0.00712, -0.00502, -0.00186, 0.00196, 0.00590, 0.00932, 0.01159, 0.01223, 0.01094, 0.00771, 0.00286, -0.00301
  , -0.00906, -0.01432, -0.01785, -0.01886, -0.01691, -0.01196, -0.00445, 0.00471, 0.01425, 0.02266, 0.02845, 0.03033, 0.02746, 0.01964, 0.00740, -0.00797
  , -0.02450, -0.03977, -0.05112, -0.05603, -0.05242, -0.03898, -0.01539, 0.01754, 0.05792, 0.10287, 0.14881, 0.19186, 0.22818, 0.25446, 0.26825, 0.26825
  , 0.25446, 0.22818, 0.19186, 0.14881, 0.10287, 0.05792, 0.01754, -0.01539, -0.03898, -0.05242, -0.05603, -0.05112, -0.03977, -0.02450, -0.00797, 0.00740
  , 0.01964, 0.02746, 0.03033, 0.02845, 0.02266, 0.01425, 0.00471, -0.00445, -0.01196, -0.01691, -0.01886, -0.01785, -0.01432, -0.00906, -0.00301, 0.00286
  , 0.00771, 0.01094, 0.01223, 0.01159, 0.00932, 0.00590, 0.00196, -0.00186, -0.00502, -0.00712, -0.00795, -0.00753, -0.00604, -0.00382, -0.00127, 0.00120
  , 0.00323, 0.00456, 0.00508, 0.00480, 0.00384, 0.00242, 0.00080, -0.00075, -0.00202, -0.00284, -0.00315, -0.00296, -0.00235, -0.00147, -0.00049, 0.00045
  , 0.00121, 0.00170, 0.00187, 0.00174, 0.00138, 0.00086, 0.00028, -0.00026, -0.00069, -0.00096, -0.00105, -0.00097, -0.00076, -0.00047, -0.00015, 0.00014
  , 0.00037, 0.00051, 0.00055, 0.00051, 0.00039, 0.00024, 0.00008, -0.00007, -0.00018, -0.00025, -0.00027, -0.00024, -0.00019, -0.00011, -0.00004, 0.00003
  , 0.00008, 0.00011, 0.00012, 0.00010, 0.00008, 0.00005, 0.00001, -0.00001, -0.00003, -0.00004, -0.00004, -0.00004, -0.00003, -0.00002, -0.00001, 0.00000
  , 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00000, 0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000
};

const float32_t channel_filter_sixteenthbw[] = {
  -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, 0.00000
  , 0.00000, 0.00000, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00000, -0.00000
  , -0.00001, -0.00001, -0.00002, -0.00003, -0.00003, -0.00004, -0.00004, -0.00004, -0.00005, -0.00005, -0.00004, -0.00004, -0.00003, -0.00002, -0.00001, 0.00001
  , 0.00002, 0.00004, 0.00006, 0.00007, 0.00009, 0.00010, 0.00011, 0.00012, 0.00012, 0.00012, 0.00011, 0.00009, 0.00007, 0.00005, 0.00002, -0.00002
  , -0.00006, -0.00010, -0.00013, -0.00017, -0.00021, -0.00024, -0.00026, -0.00027, -0.00027, -0.00026, -0.00024, -0.00021, -0.00016, -0.00010, -0.00004, 0.00004
  , 0.00012, 0.00020, 0.00029, 0.00036, 0.00043, 0.00049, 0.00053, 0.00056, 0.00056, 0.00054, 0.00049, 0.00042, 0.00032, 0.00021, 0.00007, -0.00008
  , -0.00023, -0.00040, -0.00056, -0.00070, -0.00083, -0.00094, -0.00102, -0.00106, -0.00106, -0.00101, -0.00092, -0.00078, -0.00060, -0.00039, -0.00013, 0.00014
  , 0.00043, 0.00072, 0.00101, 0.00127, 0.00150, 0.00169, 0.00181, 0.00188, 0.00187, 0.00178, 0.00161, 0.00137, 0.00105, 0.00067, 0.00023, -0.00024
  , -0.00074, -0.00124, -0.00172, -0.00217, -0.00255, -0.00286, -0.00307, -0.00316, -0.00314, -0.00298, -0.00269, -0.00228, -0.00175, -0.00111, -0.00039, 0.00040
  , 0.00121, 0.00203, 0.00281, 0.00353, 0.00415, 0.00463, 0.00496, 0.00510, 0.00505, 0.00479, 0.00432, 0.00365, 0.00279, 0.00177, 0.00061, -0.00063
  , -0.00192, -0.00321, -0.00444, -0.00556, -0.00652, -0.00727, -0.00777, -0.00798, -0.00789, -0.00747, -0.00673, -0.00567, -0.00433, -0.00274, -0.00095, 0.00098
  , 0.00297, 0.00495, 0.00684, 0.00856, 0.01003, 0.01118, 0.01194, 0.01226, 0.01211, 0.01146, 0.01032, 0.00870, 0.00664, 0.00420, 0.00146, -0.00150
  , -0.00455, -0.00759, -0.01050, -0.01315, -0.01542, -0.01719, -0.01838, -0.01889, -0.01868, -0.01770, -0.01596, -0.01347, -0.01030, -0.00653, -0.00227, 0.00234
  , 0.00713, 0.01192, 0.01653, 0.02076, 0.02443, 0.02734, 0.02934, 0.03030, 0.03009, 0.02866, 0.02597, 0.02205, 0.01696, 0.01082, 0.00379, -0.00393
  , -0.01208, -0.02039, -0.02855, -0.03623, -0.04309, -0.04881, -0.05306, -0.05554, -0.05600, -0.05422, -0.05002, -0.04330, -0.03403, -0.02222, -0.00798, 0.00852
  , 0.02704, 0.04727, 0.06886, 0.09139, 0.11441, 0.13745, 0.16001, 0.18159, 0.20171, 0.21993, 0.23581, 0.24898, 0.25915, 0.26606, 0.26956, 0.26956
  , 0.26606, 0.25915, 0.24898, 0.23581, 0.21993, 0.20171, 0.18159, 0.16001, 0.13745, 0.11441, 0.09139, 0.06886, 0.04727, 0.02704, 0.00852, -0.00798
  , -0.02222, -0.03403, -0.04330, -0.05002, -0.05422, -0.05600, -0.05554, -0.05306, -0.04881, -0.04309, -0.03623, -0.02855, -0.02039, -0.01208, -0.00393, 0.00379
  , 0.01082, 0.01696, 0.02205, 0.02597, 0.02866, 0.03009, 0.03030, 0.02934, 0.02734, 0.02443, 0.02076, 0.01653, 0.01192, 0.00713, 0.00234, -0.00227
  , -0.00653, -0.01030, -0.01347, -0.01596, -0.01770, -0.01868, -0.01889, -0.01838, -0.01719, -0.01542, -0.01315, -0.01050, -0.00759, -0.00455, -0.00150, 0.00146
  , 0.00420, 0.00664, 0.00870, 0.01032, 0.01146, 0.01211, 0.01226, 0.01194, 0.01118, 0.01003, 0.00856, 0.00684, 0.00495, 0.00297, 0.00098, -0.00095
  , -0.00274, -0.00433, -0.00567, -0.00673, -0.00747, -0.00789, -0.00798, -0.00777, -0.00727, -0.00652, -0.00556, -0.00444, -0.00321, -0.00192, -0.00063, 0.00061
  , 0.00177, 0.00279, 0.00365, 0.00432, 0.00479, 0.00505, 0.00510, 0.00496, 0.00463, 0.00415, 0.00353, 0.00281, 0.00203, 0.00121, 0.00040, -0.00039
  , -0.00111, -0.00175, -0.00228, -0.00269, -0.00298, -0.00314, -0.00316, -0.00306, -0.00286, -0.00255, -0.00217, -0.00172, -0.00124, -0.00074, -0.00024, 0.00023
  , 0.00067, 0.00105, 0.00137, 0.00161, 0.00178, 0.00187, 0.00188, 0.00181, 0.00169, 0.00150, 0.00127, 0.00101, 0.00072, 0.00043, 0.00014, -0.00013
  , -0.00039, -0.00060, -0.00078, -0.00092, -0.00101, -0.00106, -0.00106, -0.00102, -0.00094, -0.00083, -0.00070, -0.00056, -0.00040, -0.00023, -0.00008, 0.00007
  , 0.00021, 0.00032, 0.00042, 0.00049, 0.00054, 0.00056, 0.00056, 0.00053, 0.00049, 0.00043, 0.00036, 0.00029, 0.00020, 0.00012, 0.00004, -0.00004
  , -0.00010, -0.00016, -0.00021, -0.00024, -0.00026, -0.00027, -0.00027, -0.00026, -0.00024, -0.00021, -0.00017, -0.00013, -0.00010, -0.00006, -0.00002, 0.00002
  , 0.00005, 0.00007, 0.00009, 0.00011, 0.00012, 0.00012, 0.00012, 0.00011, 0.00010, 0.00009, 0.00007, 0.00006, 0.00004, 0.00002, 0.00001, -0.00001
  , -0.00002, -0.00003, -0.00004, -0.00004, -0.00005, -0.00005, -0.00004, -0.00004, -0.00004, -0.00003, -0.00003, -0.00002, -0.00001, -0.00001, -0.00000, 0.00000
  , 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001, 0.00000, 0.00000, 0.00000, -0.00000
  , -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000, -0.00000
};

int8_t init_fir_dec_2 = 0;
int8_t init_fir_dec_4 = 0;
int8_t init_fir_dec_8 = 0;
int8_t init_fir_dec_16 = 0;

static float32_t input_i[NSAMPLES];
static float32_t input_q[NSAMPLES];

/////////////////////////////////////////////////////
/////////////////////////////////////////////////////
void cf_fft_shift( float32_t *data, int len )
{
  float32_t tmp[2048];
  int i;
  if( len > 2048 ) len = 2048;

  for( i = 0; i < len / 2; i++ ) {
    tmp[i] = data[i + len / 2];
  }
  for( i = 0; i < len / 2; i++ ) {
    tmp[i + len / 2] = data[i];
  }
  for( i = 0; i < len; i++ ) {
    data[i] = tmp[i];
  }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////
void do_filter_decimate_2( float complex *iqdata )
{

  int i;

  if( !init_fir_dec_2 ) {
    arm_fir_decimate_init_f32( &Si_dec_2, 128, 2, &channel_filter_quarterbw[0], &fir_dec_state_f32_I_2[0], 128 );
    arm_fir_decimate_init_f32( &Sq_dec_2, 128, 2, &channel_filter_quarterbw[0], &fir_dec_state_f32_Q_2[0], 128 );
    /// /\  NSAMPLES///
    init_fir_dec_2 = 1;
  }


  for( i = 0; i < 128; i++ ) {
    input_i[i] = ( float32_t ) creal( iqdata[i] );
    input_q[i] = ( float32_t ) cimag( iqdata[i] );
  }

  arm_fir_decimate_f32( &Si_dec_2, input_i, iout, 128 );
  arm_fir_decimate_f32( &Sq_dec_2, input_q, qout, 128 );

}

//////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////
void do_filter_decimate_4( float complex *iqdata )
{

  int i;

  if( !init_fir_dec_4 ) {
    arm_fir_decimate_init_f32( &Si_dec_4, 128, 4, &channel_filter_quarterbw[0], &fir_dec_state_f32_I_4[0], 128 );
    arm_fir_decimate_init_f32( &Sq_dec_4, 128, 4, &channel_filter_quarterbw[0], &fir_dec_state_f32_Q_4[0], 128 );

    init_fir_dec_4 = 1;
  }


  for( i = 0; i < 128; i++ ) {
    input_i[i] = ( float32_t ) creal( iqdata[i] );
    input_q[i] = ( float32_t ) cimag( iqdata[i] );
  }

  arm_fir_decimate_f32( &Si_dec_4, input_i, iout, 128 );
  arm_fir_decimate_f32( &Sq_dec_4, input_q, qout, 128 );

}
//////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////
void do_filter_decimate_8( float complex *iqdata )
{

  int i;

  if( !init_fir_dec_8 ) {
    arm_fir_decimate_init_f32( &Si_dec_8, 256, 8, &channel_filter_eighthbw[0], &fir_dec_state_f32_I_8[0], 128 );
    arm_fir_decimate_init_f32( &Sq_dec_8, 256, 8, &channel_filter_eighthbw[0], &fir_dec_state_f32_Q_8[0], 128 );
    init_fir_dec_8 = 1;
  }


  //I filtering

  for( i = 0; i < 128; i++ ) {
    input_i[i] = ( float32_t ) creal( iqdata[i] );
    input_q[i] = ( float32_t ) cimag( iqdata[i] );
  }
  arm_fir_decimate_f32( &Si_dec_8, input_i, iout, 128 );
  arm_fir_decimate_f32( &Sq_dec_8, input_q, qout, 128 );

}

//////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////
void do_filter_decimate_16( float complex *iqdata )
{

  int i;

  if( !init_fir_dec_16 ) {
    arm_fir_decimate_init_f32( &Si_dec_16, 512, 16, &channel_filter_sixteenthbw[0], &fir_dec_state_f32_I_16[0], 128 );
    arm_fir_decimate_init_f32( &Sq_dec_16, 512, 16, &channel_filter_sixteenthbw[0], &fir_dec_state_f32_Q_16[0], 128 );
    init_fir_dec_16 = 1;
  }


  //I filtering

  for( i = 0; i < 128; i++ ) {
    input_i[i] = ( float32_t ) creal( iqdata[i] );
    input_q[i] = ( float32_t ) cimag( iqdata[i] );
  }
  arm_fir_decimate_f32( &Si_dec_16, input_i, iout, 128 );
  arm_fir_decimate_f32( &Sq_dec_16, input_q, qout, 128 );

}
